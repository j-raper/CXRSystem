;/*FB_PKG_DELIM*/

__d("LSPlatformSyncReliabilityInitQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="6565466210177072"}),null);
__d("LSPlatformSyncReliabilityInitQuery.graphql",["LSPlatformSyncReliabilityInitQuery_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a=[{kind:"Literal",name:"last",value:1}],c={alias:null,args:null,kind:"ScalarField",name:"updated_time",storageKey:null};return{fragment:{argumentDefinitions:[],kind:"Fragment",metadata:null,name:"LSPlatformSyncReliabilityInitQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:a,concreteType:"ViewerMessageThreadsConnection",kind:"LinkedField",name:"message_threads",plural:!1,selections:[{alias:null,args:null,concreteType:"ViewerMessageThreadsEdge",kind:"LinkedField",name:"edges",plural:!0,selections:[{alias:null,args:null,concreteType:"MessageThread",kind:"LinkedField",name:"node",plural:!1,selections:[c],storageKey:null}],storageKey:null}],storageKey:"message_threads(last:1)"}],storageKey:null}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[],kind:"Operation",name:"LSPlatformSyncReliabilityInitQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:a,concreteType:"ViewerMessageThreadsConnection",kind:"LinkedField",name:"message_threads",plural:!1,selections:[{alias:null,args:null,concreteType:"ViewerMessageThreadsEdge",kind:"LinkedField",name:"edges",plural:!0,selections:[{alias:null,args:null,concreteType:"MessageThread",kind:"LinkedField",name:"node",plural:!1,selections:[c,{alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:"message_threads(last:1)"}],storageKey:null}]},params:{id:b("LSPlatformSyncReliabilityInitQuery_facebookRelayOperation"),metadata:{},name:"LSPlatformSyncReliabilityInitQuery",operationKind:"query",text:null}}}();e.exports=a}),null);
__d("LSPlatformSyncReliabilityInit",["CometRelay","CometRelayEnvironment","FBLogger","I64","LSIntEnum","LSMessagingThreadTypeUtil","LSPlatformSyncReliabilityInitQuery.graphql","ODS","Promise","ReQL","asyncToGeneratorRuntime","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m=function(b){babelHelpers.inheritsLoose(a,b);function a(a){var c;c=b.call(this)||this;c.name="SyncReliabilityError";c.message=a;return c}return a}(babelHelpers.wrapNativeSuper(Error)),n=function(){return c("gkx")("10709")},o=30*1e3,p=60*1e3,q=5,r=null,s=null,t=function(a){return d("LSMessagingThreadTypeUtil").isCMFolder(a)||d("LSMessagingThreadTypeUtil").isCMGroupUnjoined(a)||d("LSMessagingThreadTypeUtil").isCMSubthread(a)},u=function(a){return(j||(j=d("I64"))).equal(a,(k||(k=d("LSIntEnum"))).ofNumber(150))||(j||(j=d("I64"))).equal(a,(k||(k=d("LSIntEnum"))).ofNumber(154))||(j||(j=d("I64"))).equal(a,(k||(k=d("LSIntEnum"))).ofNumber(155))||(j||(j=d("I64"))).equal(a,(k||(k=d("LSIntEnum"))).ofNumber(152))||(j||(j=d("I64"))).equal(a,(k||(k=d("LSIntEnum"))).ofNumber(153))},v=function(a){(l||(l=d("ODS"))).bumpEntityKey(3303,"sync_reliability_open_metric",a)},w=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield d("ReQL").firstAsync(d("ReQL").fromTableDescending(a.table("threads").index("lastActivityTimestampMs")).filter(function(a){return!d("LSMessagingThreadTypeUtil").isSecure(a.threadType)&&!t(a.threadType)&&!u(a.threadType)&&a.folderName==="inbox"})));if(!b)return null;var c=(yield d("ReQL").firstAsync(d("ReQL").fromTableDescending(a.table("messages").index("messageDisplayOrder")).getKeyRange(b.threadKey)));if(!c){a=!!(yield d("ReQL").firstAsync(d("ReQL").fromTableDescending(a.table("messages")).getKeyRange(b.threadKey)));throw new m("Unable to fetch last message from thread, threadType = "+String((k||(k=d("LSIntEnum"))).toNumber(b.threadType))+", threadHasMessages = "+String(a)+".")}return parseInt((j||(j=d("I64"))).to_float(c.timestampMs)/1e3,10)});return function(b){return a.apply(this,arguments)}}(),x=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=d("CometRelay").fetchQuery(c("CometRelayEnvironment"),h!==void 0?h:h=b("LSPlatformSyncReliabilityInitQuery.graphql"),{}).toPromise();a=(yield a)||{};a=a.viewer;return a==null?void 0:(a=a.message_threads)==null?void 0:(a=a.edges[0])==null?void 0:(a=a.node)==null?void 0:a.updated_time});return function(){return a.apply(this,arguments)}}(),y=function(a,c){return new(i||(i=b("Promise")))(function(d){window.setTimeout(b("asyncToGeneratorRuntime").asyncToGenerator(function*(){return d(yield c())}),a)})},z=function(a,b,c){if(a===q)return!1;a=r===b;b=s===c;return!a||!b},A=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var d=b.retryCount;try{b=(yield w(a));var e=(yield x());if(b==null||e==null){if(b==null&&e==null)return;c("FBLogger")("messenger_web_product").warn("A timestamp is missing for comparison LSDB = %s, GQL = %s",String(b),String(e));return}if(b===e)v("success");else if(b<e){if(z(d,b,e)){r=b;s=e;return y(o,function(){return A(a,{retryCount:d+1})})}r=null;s=null;v("failure.updates_not_received")}else{if(z(d,b,e)){r=b;s=e;return y(o,function(){return A(a,{retryCount:d+1})})}r=null;s=null;v("failure.updates_not_sent")}}catch(a){e=((b=a==null?void 0:a.name)!=null?b:"Error:")+": "+((a==null?void 0:a.description)||(a==null?void 0:a.message)||a);c("FBLogger")("messenger_web_product").catching(a).mustfix("LS Sync reliability agent failure -- %s",e)}});return function(b,c){return a.apply(this,arguments)}}();function a(a){if(!n())return function(){};var b=window.setInterval(function(){return A(a,{retryCount:0})},p);return function(){window.clearInterval(b)}}g.LOOP_INTERVAL_MS=p;g.fetchLastOMTimestampFromLSDB=w;g.compute=A;g.startAgent=a}),98);
__d("LSPlatformClientMainThread",["FBLogger","LSPlatformClientInit","LSPlatformDeviceId","LSPlatformSyncCookie","LSPlatformSyncLock","LSPlatformSyncReliabilityInit","MAWLocalStorage","Run","asyncToGeneratorRuntime","gkx"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e){function f(){d("LSPlatformSyncCookie").setSyncing();if(c("gkx")("1203"))try{var b=d("MAWLocalStorage").getStorage();d("MAWLocalStorage").setItemGuarded(b,d("LSPlatformSyncLock").SYNC_KEY,Date.now().toString())}catch(a){c("FBLogger")("mpf_web_foundations").catching(a).warn("Failed to set sync time")}try{var e=d("Run").onBeforeUnload(function(){d("LSPlatformSyncCookie").syncBeforeUnload(a),e.remove()},!1)}catch(a){c("FBLogger")("mpf_web_foundations").catching(a).warn("Failed to set before unload handler")}}var g=(yield d("LSPlatformSyncLock").use()),h=null,i=c("gkx")("6341"),j,k=i?g.onLostOnce:g.onLost;i=function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(h!==null)return;var b=d("LSPlatformDeviceId").getDeviceIdForProviderType("persisted");j==null?void 0:j();h=[yield d("LSPlatformClientInit").init(a,e,b,f,function(a){}),d("LSPlatformSyncReliabilityInit").startAgent(a)];j=k(function(){if(h!=null){var a=h,b=a[0];a=a[1];b.cleanup();a();h=null}})});return function(){return c.apply(this,arguments)}}();yield g.requestLock();g.hasLock()&&(yield i());g.onAcquired(i);return{isTabWithoutClient:function(){return g.hasLock()===!1}}});return h.apply(this,arguments)}g.make=a}),98);
__d("CrisisPageSafetyCheckRootQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="5324371214261641"}),null);